\documentclass[a4paper,12pt,russian, oneside]{article}

\usepackage{comment} % Многострочные комментарии

% XeTeX packages
\usepackage[cm-default]{fontspec} % or install lmodern and remove cm-default opt
\usepackage{xunicode} % some extra unicode support
\usepackage{xltxtra} % \XeLaTeX macro


\tolerance=1000
\emergencystretch=0.74cm

\usepackage{indentfirst} %делать отступ в начале параграфа
\setlength{\parindent}{1.25cm}
\setlength{\parskip}{3.0mm} %Расстояние между абзацами 



\usepackage[pdfborder = {0 0 0}]{hyperref} %гиперссылки в документе.

\usepackage[utf8]{inputenc}	% кодировка текста
\usepackage[russian]{babel} % руссификация по Бабелю
\usepackage{graphics}

%\usepackage[clean,pdf]{svg}

\usepackage{amsmath, amsfonts} % для расширенных настроек ссылок на формулы
\usepackage{extsizes} % использование шрифтов большего кегля 

\usepackage{fancyvrb} % Добавляет продвинутые Verbatim и Verb

\usepackage{epsfig} % удобно вставлять рисунки в строку текста
\usepackage[usenames,dvipsnames]{pstricks}
\usepackage{pst-grad} % For gradients
\usepackage{pst-plot} % For axes

\usepackage{graphicx,xcolor}
\usepackage{minted}



\usepackage{array}
\usepackage{tabularx}
\usepackage{supertabular}
\usepackage{longtable} % для создания таблиц, переносящихся на другую страницу

\usepackage{textcomp} % Ввод различных знаков
\usepackage{keystroke} % для отображения символов клавиш
\usepackage{bytefield} %для создания таблиц с битовыми полями
\usepackage{filecontents} %для включения в документ содержимого файлов

\usepackage{tikz} % Пакет для рмсования диаграмм
\usepackage{tikz-timing}[2009/12/09]
\usetikzlibrary{arrows}
\usepackage{tikzit}
\input{sample.tikzstyles}

\usetikzlibrary{positioning,arrows,automata,plotmarks} %В данном случае нам потребуются positioning и arrows, которые нужны для расположения элементов друг относительно друга и рисования стрелок между ними соответственно.
\usetikzlibrary{shapes,snakes}
\usepackage{schemabloc}

\usepackage{makecell} % Для многострочных ячеек таблицы
\usepackage{colortbl} % Для раскрашивания ячеек в таблицах


\setromanfont{Times New Roman}
\setsansfont{Arial}
\setmonofont{Consolas} %\texttt{} \verb||
\setmainfont{Times New Roman}



%\newcommand{\chaptermarkI}[1]{\markright{#1}}
%\renewcommand{\chaptermark}[1]{\markright{ГЛАВА\ \thepart.\ #1}}


\usepackage{eso-pic}


\usepackage{newverbs}
\renewenvironment{verbatim}
{\semiverbatim\color{Violet}}
{\endsemiverbatim}
\renewcommand{\verb}{\collectverb{\color{Violet}}}

\let\OldTexttt\texttt
\renewcommand{\texttt}[1]{\textcolor{Violet}{\OldTexttt{#1}}}


\usepackage[top=2.0cm, left=3.0cm, right=1.5cm, bottom=2.0cm]{geometry}


\input{commands.tex}

\begin{document}% Начало самого документа (содержательной части)

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{4} % n=4 это chapter, section, subsection, subsubsection и paragraph; -> toc


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% Используемые тэги в проекте %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{comment}


% Цитирование Си-кода
\begin{CcodeII}
--//--
\end{CcodeII}

% Цитирование bash-кода
\begin{BASHcode}
--//--
\end{BASHcode}

%Цитируемый текст
\begin{TEXTcode}
--//--
\end{TEXTcode}

% Цитирование make-кода
\begin{MAKEFILEcode}
--//--
\end{MAKEFILEcode}

% Для текстового псевдорисунка
\begin{TEXTpicture}
--//--
\end{TEXTpicture}



%Цитирование внутри текста
\verb|--//--|

\texttt{}
%Жирный жрифт
\textbf{}
%Наклонный шрифт
\textit{}

%Ссылка
\url{https://--//--}

%Ненумерованное перечисление
\begin{itemize}
  \item 
  \item 
\end{itemize}

%Нумерованное перечисление
\begin{enumerate}
  \item 
  \item 
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Секция}

  \subsection*{Подсекция}

    \paragraph*{Параграф}
    \

%Картинка из многостраничного *.pdf
\begin{figure}[H]%
  \centering
  \includegraphics[scale = 1.0, page = 7, viewport=20.0mm 25.0mm 180.0mm 125.0mm, clip]{origin/LinuxDeviceDriversDevelopment_ColorImages.pdf}%
  \caption{Шинная архитектура драйверов с сновной псевдошиной} 
\end{figure}% scale = 0.3, width=\textwidth

%Таблица в две колони с автопереносом на другую страницу
\small
\begin{longtable}{|C{50mm}|C{100mm}|}
  \caption{Прерывания} \label{t:interrupts} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{50mm}|}{\centering Номер прерывания} &
  \multicolumn{1}{L{100mm}|}{\centering Описание} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:interrupts}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{50mm}|}{\centering Номер прерывания} &
  \multicolumn{1}{L{100mm}|}{\centering Описание} \\\hline
  \endhead
   0      &  Ошибка деления на ноль    \\ \hline
\end{longtable} \normalsize



\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagestyle{empty} % нумерация выкл.
\

\vspace{70mm}
\parbox{1\textwidth}{\centering
\LARGE Библиотека 'lproc\_queue'

\Large Расширение языка lua 5.3+
}

\vspace{155mm}
\parbox{1\textwidth}{\centering
\today
}




\newpage
\pagestyle{plain} % нумерация вкл.
\tableofcontents % Содержание

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Назначение}


Проект представляет собой библиотеку многопоточности,
основанной на библиотеке Linux pthread для Lua 5.3+ (\url{https://www.lua.org/pil}).

Исходники основаны на проекте из книжки \url{https://www.lua.org/pil/3/lproc.c}.
Недостатком оригинального проекта является то, что межпоточная коммуникация
основана на одиночных сообщениях, которые вызывают блокировку, скажем,
отправляющего сообщение потока в случае если получатель ещё не прочитал
предыдущее сообщение. В результате потоки ждут друг друга и нередко
всё самоблокируется.

В данной библиотеке механизм сообщений между потоками полностью заменён.
Новый механизм основан на очередях сообщений. Каждая очередь состоит из 256
элементов. Каждый элемент содержит 256 байт. Эти размеры можно переопределить
на стадии компиляции. Всего таких очередей может быть сколько угодно. Очереди
организованы в кольцевой двусвязанный список.

Благодаря механизму очередей сообщений становится возможным реализация 
неблокирующих вызовов 'положить в очередь' и 'извлечь из очереди'. Таким
образом, потоки выполняются независимо друг от друга и в тоже время обмениваются
друг с другом данными.

Исключительные ситуации 'очередь пуста' и 'очередь заполнена' обрабатываются и
возвращаются в Lua.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Сборка}

Для сборки нужны пакеты \verb|lua5.3|, \verb|liblua5.3-dev|, \verb|make|, \verb|gcc|.


\subsection{Сборка под Eclipse CDT}

\begin{enumerate}
\item Открыть Eclipse CDT.

\item \textbf{File} $\rightarrow$ \textbf{Import} $\rightarrow$ \textbf{Existing Progect into Workspace}, нажмите \keystroke{Next>}

\item В \textbf{Select root directory} укажите путь к файлу \verb|.progect| проекта, нажмите \keystroke{Finish}

\item Нажмите \keystroke{Build}. Результат появится папке \verb|./Release*|
\end{enumerate}



\subsection{Сборка под make}


\begin{BASHcode}
cd ~/lproc_queue/lproc_queue
make
\end{BASHcode}

При необходимости, нужно отредактировать пути к компилятору и lua в файле \verb|makefile|.



\subsection{Результат компиляции}

В процессе компиляции создаётся \verb|lproc_queue.so| lua - библиотека.

\subsection{Первый запуск}

Тестовый проект лежит в папке \verb|lproc_queue/lproc_queue/tests/probe_01/|
рядом с символической ссылкой на библиотеку. Для запуска теста надо перейти
в эту папку и ввести команду.
\begin{BASHcode}
lua5.3 ./probe_01.lua
\end{BASHcode}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Поддерживаемые платформы}

\subsection{Ubuntu 20.04}

Проект собирается, но тестировался не в полном объёме...


%\subsection{Встраиваемые Linux - системы на базе ARM/Cortex}

%Проект собирается, но тестировался не в полном объёме...




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Описание функций}

\subsection{Статические функции}

\subsubsection{\texttt{version()} - версия библиотеки}

\small
\begin{longtable}{|C{7mm}|C{15mm}|C{26mm}|L{73mm}|C{21mm}|}
  \caption{Функция \texttt{ version() }} \label{t:version} \\
  \hline
  \rowcolor{ColorFunction}
  \multicolumn{5}{|c|}{\centering  (string version) = version() } \\\hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:version}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endhead
  \rowcolor{ColorRet}
  \multicolumn{5}{|c|}{\centering Возвращаемые значения } \\\hline
  1 & string & version &  Строка с версиями библиотек &  \\ \hline
\end{longtable} \normalsize


\begin{Lua}
local lproc_queue = require('lproc_queue')

local version = lproc_queue.version()     --[[ <--- ]]
print(version)
\end{Lua}



\newpage
\subsubsection{Задержки}

\paragraph{\texttt{delay\_us()} - задержка в микросекундах}
\

\small
\begin{longtable}{|C{7mm}|C{15mm}|C{26mm}|L{73mm}|C{21mm}|}
  \caption{Функция \texttt{ delay\_us()}} \label{t:delay_us} \\
  \hline
  \rowcolor{ColorFunction}
  \multicolumn{5}{|c|}{\centering  delay\_us(integer us) } \\\hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:delay_us}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endhead
  \rowcolor{ColorArgs}
  \multicolumn{5}{|c|}{\centering Аргументы } \\\hline
  1 & integer & us & На сколько микросекунд задержать &  \\ \hline
\end{longtable} \normalsize

\begin{Lua}
local lproc_queue = require('lproc_queue')
...
lproc_queue.delay_us(300)  --[[ <--- ]]
\end{Lua}



\paragraph{\texttt{delay\_ms()} - задержка в миллисекундах}
\

\small
\begin{longtable}{|C{7mm}|C{15mm}|C{26mm}|L{73mm}|C{21mm}|}
  \caption{Функция \texttt{ delay\_ms(integer ms) }} \label{t:delay_ms} \\
  \hline
  \rowcolor{ColorFunction}
  \multicolumn{5}{|c|}{\centering  delay\_ms() } \\\hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:delay_ms}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endhead
  \rowcolor{ColorArgs}
  \multicolumn{5}{|c|}{\centering Аргументы } \\\hline
  1 & integer & ms & На сколько миллисекунд задержать &  \\ \hline
\end{longtable} \normalsize

\begin{Lua}
local lproc_queue = require('lproc_queue')
...
lproc_queue.delay_ms(300)  --[[ <--- ]]
\end{Lua}




\paragraph{\texttt{delay\_s()} - задержка в секундах}
\

\small
\begin{longtable}{|C{7mm}|C{15mm}|C{26mm}|L{73mm}|C{21mm}|}
  \caption{Функция \texttt{ delay\_s() }} \label{t:delay_s} \\
  \hline
  \rowcolor{ColorFunction}
  \multicolumn{5}{|c|}{\centering delay\_s(integer s) } \\\hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:delay_s}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endhead
  \rowcolor{ColorArgs}
  \multicolumn{5}{|c|}{\centering Аргументы } \\\hline
  1 & integer & s & На сколько секунд задержать &  \\ \hline
\end{longtable} \normalsize

\begin{Lua}
local lproc_queue = require('lproc_queue')
...
lproc_queue.delay_s(2)  --[[ <--- ]]
\end{Lua}


\newpage
\subsubsection{\texttt{timeofday()} - обёртка над gettimeofday()}

Возвращает системное время в секундах от 1970~г. и довесок к этому в мкСек.

\small
\begin{longtable}{|C{7mm}|C{15mm}|C{26mm}|L{73mm}|C{21mm}|}
  \caption{Функция \texttt{ timeofday() }} \label{t:timeofday} \\
  \hline
  \rowcolor{ColorFunction}
  \multicolumn{5}{|c|}{\centering (integer s), (integer us) = timeofday() } \\\hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endfirsthead
  \caption*{Продолжение таблицы \ref{t:timeofday}} \\
  \hline
  \rowcolor{Gray}
  \multicolumn{1}{|C{7mm}}{№} &
  \multicolumn{1}{|C{15mm}}{\centering Тип} &
  \multicolumn{1}{|C{26mm}}{\centering Имя} &
  \multicolumn{1}{|L{73mm}}{\centering Описание} &
  \multicolumn{1}{|C{21mm}|}{\centering По умолчанию} \\\hline
  \endhead
  \rowcolor{ColorRet}
  \multicolumn{5}{|c|}{\centering Возвращаемые значения } \\\hline
  1 & integer & s      & Количество секунд, прошедших с начала Эпохи (1 января 1970~г.) & \\ \hline
  2 & integer & us     & Дополнение к секундам с начала Эпохи в микросекундах  &  \\ \hline
\end{longtable} \normalsize


\begin{Lua}
local lproc_queue = require('lproc_queue')
...
local sec, usec = lproc_queue.timeofday()  --[[ <--- ]]
\end{Lua}








\end{document}
